<<<<<<< HEAD
# 医学影像标注工具 (CPR Annotation Tool)

医学影像CPR（曲面重建）数据标注工具,用于标注血管斑块和狭窄程度。

## 功能特点

- ✅ 支持NRRD格式的CPR数据
- ✅ 三视图显示(X轴、Y轴、Z轴截面)
- ✅ 可视化标注区间选择
- ✅ 多维度标注(斑块存在性、类型、狭窄程度、置信度)
- ✅ 自动冲突检测和解决(优先保存高置信度和新标注)
- ✅ 基于Web的用户界面,易于使用
- ✅ 支持标注的编辑和删除
- ✅ 标注数据自动保存为JSON格式

## 系统要求

- Python 3.8 或更高版本
- 至少 4GB 内存
- 支持的操作系统: Windows / macOS / Linux

## 安装步骤

### 1. 安装Python依赖

```bash
cd annotation_tool
pip install -r requirements.txt
```

### 2. 运行应用

```bash
python app.py
```

默认情况下,服务器将在 `http://127.0.0.1:5000` 启动。

### 可选参数

```bash
# 指定端口
python app.py --port 8080

# 指定监听地址(允许局域网访问)
python app.py --host 0.0.0.0 --port 5000

# 启用调试模式
python app.py --debug
```

## 使用说明

### 1. 设置医生信息

- 在左侧工具栏输入医生名字
- 点击"确认"按钮

### 2. 选择数据目录

- 输入包含NRRD文件的目录路径
- 点击"加载"按钮
- 系统会自动扫描目录中的所有NRRD文件

### 3. 加载数据文件

- 在文件列表中点击要标注的文件
- 系统会自动加载数据并显示三个视图

### 4. 标注操作

#### 选择标注区间

方法1: 使用键盘
- 切换到"选择"工具
- 使用上下箭头键浏览Z轴切片
- 按空格键标记起始位置
- 继续浏览到结束位置
- 再次按空格键标记结束位置

方法2: 手动输入
- 在右侧面板的"标注区间"中直接输入起始Z和结束Z

#### 填写标注信息

- **维度A - 斑块存在性**: 有斑块 / 无斑块 / 明确怀疑有 / 无法判断
- **维度B - 斑块类型**: 不确定 / 钙化 / 非钙化 / 混合
- **维度C - 确定不是**: 多选排除项
- **维度D - 狭窄程度**: <25% / 25-49% / 50-69% / ≥70% / 无法判断
- **维度E - 置信度**: 高 / 中 / 低

#### 保存标注

- 点击"添加标注"按钮
- 标注会出现在下方的"已标注区域"列表中

### 5. 编辑/删除标注

- 在"已标注区域"列表中右键点击标注
- 选择"编辑标注"或"删除标注"

### 6. 保存到文件

- 点击左下角的"保存标注"按钮
- 标注数据会保存到与原始数据相同的目录
- 文件命名格式: `[原数据名]_[医生名字]_label.json`

## 标注数据格式

标注文件采用JSON格式,包含以下信息:

```json
{
  "data_file": "原始数据文件名.nrrd",
  "doctor_name": "医生名字",
  "last_modified": "2026-02-11 10:30:00",
  "annotations": [
    {
      "annotation_id": "唯一ID",
      "z_start": 100,
      "z_end": 150,
      "presence": 1,
      "type_main": 1,
      "type_exclude": ["not_CP"],
      "stenosis": 2,
      "confidence": 2,
      "timestamp": "2026-02-11 10:30:00"
    }
  ]
}
```

### 字段说明

- `presence`: -1(无斑块), 1(有斑块), 0(怀疑有), null(无法判断)
- `type_main`: 0(不确定), 1(钙化), 2(非钙化), 3(混合)
- `type_exclude`: 数组,可包含 "not_CP", "not_NCP", "not_MP"
- `stenosis`: 0(<25%), 1(25-49%), 2(50-69%), 3(≥70%), 4(无法判断)
- `confidence`: 0(低), 1(中), 2(高)

## 冲突解决规则

当标注区间重叠时,系统会自动解决冲突:

1. **优先级**: 置信度高的优先
2. **次要规则**: 置信度相同时,时间戳晚的优先
3. 保存时会自动分割重叠区域,保留高优先级的标注

## 项目结构

```
annotation_tool/
├── app.py                    # Flask后端主程序
├── requirements.txt          # Python依赖
├── README.md                 # 本文档
├── utils/
│   ├── nrrd_loader.py       # NRRD数据加载工具
│   └── annotation_manager.py # 标注管理工具
├── templates/
│   └── index.html           # 前端HTML模板
├── static/
│   ├── css/
│   │   └── style.css        # 样式文件
│   └── js/
│       └── viewer.js        # 前端交互逻辑
└── data/                    # 数据目录(用户数据)
```

## 快捷键

- **上/下箭头**: 浏览Z轴切片
- **空格键**: 在选择模式下标记起始/结束位置
- **右键**: 在标注列表中打开编辑/删除菜单

## 注意事项

1. **数据路径**: 确保输入的目录路径是绝对路径
2. **内存使用**: 大型NRRD文件可能占用较多内存
3. **浏览器兼容性**: 推荐使用Chrome、Edge或Firefox浏览器
4. **数据备份**: 建议定期备份标注文件

## 常见问题

### 1. 无法加载NRRD文件?

- 检查文件路径是否正确
- 确保文件是标准的NRRD格式
- 检查Python依赖是否正确安装

### 2. 标注保存失败?

- 检查目录是否有写入权限
- 确保医生名字已设置

### 3. 切片显示异常?

- 刷新页面重新加载
- 检查NRRD文件的spacing和shape信息

## 开发信息

- **开发语言**: Python (后端), JavaScript (前端)
- **框架**: Flask, HTML5 Canvas
- **数据处理**: SimpleITK, NumPy

## 许可证

本工具仅供医学研究和教学使用。

## 联系方式

如有问题或建议,请联系开发团队。
=======
# CPR_Annotation_Tool
>>>>>>> a17bd49680cd5f02e3fdc17317c52b09705bdace
